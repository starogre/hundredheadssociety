rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (
        request.auth.uid == userId || 
        (userId.matches('test_.*') && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        ))
      );
      
      // Allow update of own document, test users, or admins/moderators updating specific fields
      allow update: if request.auth != null && (
        request.auth.uid == userId || 
        (userId.matches('test_.*') && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        )) ||
        (
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
          ) && (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isAdmin']) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isModerator']) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['userRole'])
          )
        )
      );
      
      // Allow delete of own document, test users, or if you're an admin (moderators CANNOT delete)
      allow delete: if request.auth != null && (
        request.auth.uid == userId || 
        (userId.matches('test_.*') && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        )) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
      );

      match /notifications/{notificationId} {
        // Allow user to read/write their own notifications, and allow admins/moderators to write notifications to any user
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && (
          request.auth.uid == userId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        );
      }
    }
    
    // Portraits collection
    match /portraits/{portraitId} {
      allow create: if request.auth != null && (
        request.auth.uid == request.resource.data.userId ||
        (request.resource.data.userId.matches('test_.*') && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        ))
      );
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        (resource.data.userId.matches('test_.*') && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        ))
      );
    }

    // Weekly Sessions collection
    match /weekly_sessions/{sessionId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth != null;
    }

    // Upgrade Requests collection
    match /upgrade_requests/{requestId} {
      // Allow authenticated users to create a request for themselves
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Allow users to read their own requests
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Allow only admins or moderators to read, update, or delete any upgrade requests
      allow read, update, delete: if request.auth != null &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        );
    }

    // Activity Logs collection
    match /activity_logs/{logId} {
      // Allow only admins or moderators to read activity logs
      allow read: if request.auth != null &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        );
      
      // Allow the system to create activity logs (for user signups and other automated actions)
      allow create: if request.auth != null;
    }
    
    // Models collection
    match /models/{modelId} {
      // Allow all authenticated users to read models (for portrait creation)
      allow read: if request.auth != null;

      // Allow only admins or moderators to create, update, or delete models
      allow create, update, delete: if request.auth != null &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true
        );
    }

    // Reports collection
    match /reports/{reportId} {
      // Users can create reports
      allow create: if request.auth != null 
        && request.resource.data.reporterUserId == request.auth.uid
        && request.resource.data.status == 'pending';
      
      // Users can read their own reports
      allow read: if request.auth != null 
        && (resource.data.reporterUserId == request.auth.uid
            || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
            || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true);
      
      // Only admins and moderators can update reports
      allow update: if request.auth != null 
        && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
            || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true);
      
      // Only admins can delete reports
      allow delete: if request.auth != null 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Blocks collection - User blocking system
    match /blocks/{blockId} {
      // Allow users to create blocks where they are the blocker
      // blockId format: "blockerId_blockedUserId"
      allow create: if request.auth != null 
        && blockId == request.auth.uid + '_' + request.resource.data.blockedUser
        && request.resource.data.blockedBy == request.auth.uid
        && request.resource.data.blockedUser is string
        && request.resource.data.createdAt == request.time;
      
      // Allow users to read blocks where they are involved (either blocker or blocked)
      allow read: if request.auth != null 
        && (resource.data.blockedBy == request.auth.uid 
            || resource.data.blockedUser == request.auth.uid);
      
      // Allow users to delete blocks they created (unblock)
      allow delete: if request.auth != null 
        && resource.data.blockedBy == request.auth.uid;
      
      // No updates allowed - blocks are immutable
    }
  }
}
